---
title: "An introduction to the SpatialFeatures Package"
author:
- name: Guan Gui, Shila Ghazanfar
  affiliation:
  - School of Mathematics and Statistics, The University of Sydney, Sydney, NSW, 2006, Australia
  - Charles Perkins Centre, The University of Sydney, Sydney, NSW, 2006, Australia
  - Sydney Precision Data Science Centre, The University of Sydney, Sydney, NSW, 2006, Australia
output:
  BiocStyle::html_document:
    toc_float: true
  BiocStyle::pdf_document: default
package: SpatialFeatures
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Getting started: SpatialFeatures}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  message = FALSE,
  warning = FALSE,
  comment = "#>"
)
```

# SpatialFeatures
The R package `SpatialFeatures` contains functions to extract features from molecule-resolved spatial transcriptomics data using objects from the `MoleculeExperiment` class.

## Load Required Libraries
```{r}
library(SpatialFeatures)
library(MoleculeExperiment)
library(ggplot2)
library(SummarizedExperiment)
library(dplyr)
```

## Create Example Dataset
Load an example `MoleculeExperiment` object with Xenium data:
```{r}
repoDir <- system.file("extdata", package = "MoleculeExperiment")
repoDir <- paste0(repoDir, "/xenium_V1_FF_Mouse_Brain")

me <- readXenium(repoDir, keepCols = "essential")
me
```

## Quick start

The `spatialFeatures` function performs three key steps

```{r}
se = spatialFeatures(me)
se
```

# Step-by-step SpatialFeatures

## Generate new boundaries based on subcellular and supercellular features

This function `loadBoundaries(me)` processes the given data (`me`) and returns feature data based on multiple assay types, including:
- Sub-Sector
- Sub-Concentric
- Super-Sector
- Super-Concentric
```{r}
me <- SpatialFeatures::loadBoundaries(me)
me
```


## Draw the Feature Boundary Plots

Visualize the spatial molecule and cell boundary map with SpatialFeature boundaries.
```{r}
ggplot_me() +
  # add molecule points and colour by feature name
  geom_point_me(me, byColour = "feature_id", size = 0.1) +
  # add nuclei segments and colour the border with red
  geom_polygon_me(me, assayName = "sub_sector", fill = NA, colour = "red") +
  # add cell segments and colour by cell id
  geom_polygon_me(me, byFill = "segment_id", colour = "black", alpha = 0.1) +
  # zoom in to selected patch area
  coord_cartesian(xlim = c(4875, 4950), ylim = c(6385, 6455))

ggplot_me() +
  # add molecule points and colour by feature name
  geom_point_me(me, byColour = "feature_id", size = 0.1) +
  # add nuclei segments and colour the border with red
  geom_polygon_me(me, assayName = "sub_concentric", fill = NA, colour = "red") +
  # add cell segments and colour by cell id
  geom_polygon_me(me, byFill = "segment_id", colour = "black", alpha = 0.1) +
  # zoom in to selected patch area
  coord_cartesian(xlim = c(4875, 4950), ylim = c(6385, 6455))

ggplot_me() +
  # add molecule points and colour by feature name
  geom_point_me(me, byColour = "feature_id", size = 0.1) +
  # add nuclei segments and colour the border with red
  geom_polygon_me(me, assayName = "super_sector", fill = NA, colour = "blue") +
  # add cell segments and colour by cell id
  geom_polygon_me(me, byFill = "segment_id", colour = "black", alpha = 0.1) +
  # zoom in to selected patch area
  coord_cartesian(xlim = c(4875, 4950), ylim = c(6385, 6455))

ggplot_me() +
  # add molecule points and colour by feature name
  geom_point_me(me, byColour = "feature_id", size = 0.1) +
  # add nuclei segments and colour the border with red
  geom_polygon_me(me, assayName = "super_concentric", fill = NA, colour = "blue") +
  # add cell segments and colour by cell id
  geom_polygon_me(me, byFill = "segment_id", colour = "black", alpha = 0.1) +
  # zoom in to selected patch area
  coord_cartesian(xlim = c(4875, 4950), ylim = c(6385, 6455))
```

## Create Entropy Matrix

This function `EntropyMatrix()` computes the entropy of a counts matrix from a `MoleculeExperiment` object based on the given assay type.
```{r}
ent = SpatialFeatures::EntropyMatrix(me, c("sub_sector", "sub_concentric", "super_sector", "super_concentric"), nCores = 1)
lapply(ent, head, n = 4)
```

## Create `SummarizedExperiment` Object

This function `EntropySummarizedExperiment()` Convert the entropy matrix into a `SummarizedExperiment` object.
```{r}
se = SpatialFeatures::EntropySummarizedExperiment(ent, me)
se
```

If you also want the gene counts, you can include the parameter

```{r}
se = EntropySummarizedExperiment(ent, me, includeCounts = TRUE)
se
```

## Inspect the SpatialFeatures SummarizedExperiment Object
Check the structure and content of the SummarizedExperiment object:
```{r}
se
colData(se)
rowData(se)
```

# Finish

```{r}
sessionInfo()
```

